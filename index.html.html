<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dog Vision ğŸ¾</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@300;400;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --cream: #f5f0e8;
    --dark: #1a1a1a;
    --paw: #d4a96a;
    --accent: #4a7fa5;
  }

  body {
    background: var(--dark);
    color: var(--cream);
    font-family: 'Noto Sans KR', sans-serif;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px 10px;
    background: rgba(26,26,26,0.95);
    z-index: 10;
    border-bottom: 1px solid rgba(212,169,106,0.2);
    flex-shrink: 0;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    letter-spacing: 3px;
    color: var(--paw);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .logo span { color: var(--cream); }

  .toggle-btn {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--cream);
    padding: 7px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .toggle-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }

  .camera-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #000;
  }

  video {
    position: absolute;
    width: 100%; height: 100%;
    object-fit: cover;
    display: none;
  }

  canvas#viewCanvas {
    position: absolute;
    width: 100%; height: 100%;
    object-fit: cover;
  }

  .mode-label {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(6px);
    border: 1px solid rgba(212,169,106,0.4);
    color: var(--cream);
    font-size: 12px;
    padding: 4px 14px;
    border-radius: 20px;
    z-index: 5;
    letter-spacing: 1px;
    white-space: nowrap;
  }

  .flip-btn {
    position: absolute;
    top: 12px;
    right: 14px;
    z-index: 5;
    background: rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    width: 38px; height: 38px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.3s;
  }
  .flip-btn:active { transform: rotate(180deg) scale(0.9); }

  .controls {
    flex-shrink: 0;
    background: rgba(26,26,26,0.97);
    border-top: 1px solid rgba(212,169,106,0.2);
    padding: 16px 24px 32px;
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 16px;
    z-index: 10;
  }

  .shutter-wrap {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shutter {
    width: 70px; height: 70px;
    border-radius: 50%;
    background: var(--cream);
    border: 4px solid var(--paw);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    transition: transform 0.1s;
    position: relative;
    z-index: 1;
  }
  .shutter:active { transform: scale(0.88); }

  .shutter-ring {
    width: 82px; height: 82px;
    border-radius: 50%;
    border: 2px solid rgba(212,169,106,0.3);
    position: absolute;
    pointer-events: none;
  }

  .preview-thumb {
    width: 52px; height: 52px;
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    overflow: hidden;
    cursor: pointer;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }
  .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }

  .info-badge {
    font-size: 11px;
    color: rgba(245,240,232,0.4);
    text-align: center;
    line-height: 1.6;
    max-width: 60px;
  }

  .flash-overlay {
    position: absolute;
    inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 20;
    transition: opacity 0.4s ease-out;
  }
  .flash-overlay.active { opacity: 0.85; transition: none; }

  .gallery-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 100;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .gallery-modal.open { display: flex; }
  .gallery-modal img {
    max-width: 100%;
    max-height: 75vh;
    border-radius: 12px;
    object-fit: contain;
    box-shadow: 0 0 40px rgba(0,0,0,0.8);
  }
  .gallery-actions {
    display: flex;
    gap: 14px;
    margin-top: 20px;
  }
  .gallery-actions button {
    background: var(--paw);
    color: var(--dark);
    border: none;
    padding: 11px 24px;
    border-radius: 24px;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .gallery-actions button:active { transform: scale(0.95); }
  .gallery-actions .close-btn {
    background: rgba(255,255,255,0.12);
    color: var(--cream);
  }

  .permission-msg {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    color: rgba(245,240,232,0.65);
    font-size: 15px;
    text-align: center;
    padding: 40px;
    z-index: 3;
    line-height: 1.7;
  }
  .permission-msg .icon { font-size: 52px; margin-bottom: 6px; }
  .start-btn {
    background: var(--paw);
    color: var(--dark);
    border: none;
    padding: 13px 32px;
    border-radius: 28px;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
    letter-spacing: 0.5px;
  }
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ¾ <span>DOG</span>VISION</div>
  <button class="toggle-btn" id="toggleMode">ğŸ‘¤ ì¸ê°„ ì‹œì </button>
</header>

<div class="camera-wrap">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="viewCanvas"></canvas>
  <div class="mode-label" id="modeLabel">ğŸ¶ ê°•ì•„ì§€ ì‹œì </div>
  <button class="flip-btn" id="flipBtn" title="ì¹´ë©”ë¼ ì „í™˜">ğŸ”„</button>
  <div class="flash-overlay" id="flashOverlay"></div>

  <div class="permission-msg" id="permMsg">
    <div class="icon">ğŸ•</div>
    <p>ì¹´ë©”ë¼ë¥¼ ì¼œì„œ<br>ê°•ì•„ì§€ì˜ ëˆˆìœ¼ë¡œ ì„¸ìƒì„ ë³´ì„¸ìš”</p>
    <button class="start-btn" id="startBtn">ì¹´ë©”ë¼ ì‹œì‘</button>
  </div>
</div>

<div class="controls">
  <div class="preview-thumb" id="previewThumb">ğŸ¾</div>
  <div class="shutter-wrap">
    <div class="shutter-ring"></div>
    <div class="shutter" id="shutterBtn">ğŸ“¸</div>
  </div>
  <div class="info-badge">íƒ­í•˜ì—¬<br>ì‚¬ì§„ ì €ì¥</div>
</div>

<div class="gallery-modal" id="galleryModal">
  <img id="galleryImg" src="" alt="ì°ì€ ì‚¬ì§„">
  <div class="gallery-actions">
    <button id="saveBtn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
    <button class="close-btn" id="closeModal">âœ• ë‹«ê¸°</button>
  </div>
</div>

<canvas id="captureCanvas" style="display:none"></canvas>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG: í•˜ë‹¨ í”„ë ˆì„ PNG íŒŒì¼ ê²½ë¡œ
// ë‚˜ì¤‘ì— frame.png íŒŒì¼ì„ ê°™ì€ í´ë”ì— ë„£ìœ¼ë©´ ìë™ ì ìš©ë©ë‹ˆë‹¤
const FRAME_PNG_PATH = 'frame.png';
// í”„ë ˆì„ ë†’ì´ ë¹„ìœ¨ (ìº¡ì²˜ ì´ë¯¸ì§€ ë†’ì´ ëŒ€ë¹„)
const FRAME_HEIGHT_RATIO = 0.18;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let stream = null;
let facingMode = 'environment';
let isDogMode = true;
let animFrame = null;
let lastDataUrl = null;

const video         = document.getElementById('video');
const viewCanvas    = document.getElementById('viewCanvas');
const ctx           = viewCanvas.getContext('2d', { willReadFrequently: true });
const permMsg       = document.getElementById('permMsg');
const startBtn      = document.getElementById('startBtn');
const flipBtn       = document.getElementById('flipBtn');
const toggleMode    = document.getElementById('toggleMode');
const modeLabel     = document.getElementById('modeLabel');
const shutterBtn    = document.getElementById('shutterBtn');
const flashOverlay  = document.getElementById('flashOverlay');
const previewThumb  = document.getElementById('previewThumb');
const galleryModal  = document.getElementById('galleryModal');
const galleryImg    = document.getElementById('galleryImg');
const saveBtn       = document.getElementById('saveBtn');
const closeModal    = document.getElementById('closeModal');
const captureCanvas = document.getElementById('captureCanvas');

// â”€â”€ Dog Vision Color Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê°œì˜ dichromacy(ì´ìƒ‰í˜• ìƒ‰ë§¹) êµ¬í˜„:
// S-cone(~430nm íŒŒë‘)ê³¼ L-cone(~555nm ë…¸ë‘-ì´ˆë¡)ë§Œ ìˆê³  M-cone ì—†ìŒ
// ìŠ¤í™íŠ¸ëŸ¼ ì´ë¯¸ì§€ ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘:
//  ë¹¨ê°•/ì£¼í™© â†’ íƒí•œ ë…¸ë€ìƒ‰
//  ë…¸ë‘      â†’ ì„ ëª…í•œ ë…¸ë€ìƒ‰
//  ì´ˆë¡/ì²­ë¡ â†’ íšŒìƒ‰
//  íŒŒë‘      â†’ íŒŒë‘ ìœ ì§€
//  ë³´ë¼      â†’ íšŒìƒ‰ë¹› íŒŒë‘
function rgbToDog(r, g, b) {
  // Normalize
  const rn = r / 255, gn = g / 255, bn = b / 255;
  const max = Math.max(rn, gn, bn), min = Math.min(rn, gn, bn);
  const l = (max + min) / 2;
  let h = 0, s = 0;

  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case rn: h = ((gn - bn) / d + (gn < bn ? 6 : 0)) / 6; break;
      case gn: h = ((bn - rn) / d + 2) / 6; break;
      case bn: h = ((rn - gn) / d + 4) / 6; break;
    }
  }

  const hDeg = h * 360;
  let dH, dS, dL = l;

  // Achromatic (gray/white/black) â†’ pass through
  if (s < 0.08) {
    dH = 0; dS = 0; dL = l;
  } else if (hDeg < 30) {
    // Red â†’ dull yellow
    dH = 58; dS = s * 0.55; dL = l * 0.88;
  } else if (hDeg < 65) {
    // Orange/Yellow â†’ bright yellow
    dH = 55; dS = s * 0.9; dL = l;
  } else if (hDeg < 175) {
    // Yellow-green / Green / Cyan-green â†’ gray
    dH = 0; dS = 0; dL = l;
  } else if (hDeg < 265) {
    // Cyan / Blue â†’ blue
    dH = 218; dS = s * 0.85; dL = l;
  } else if (hDeg < 330) {
    // Blue-violet / Violet â†’ blue-gray
    dH = 218; dS = s * 0.45; dL = l * 0.92;
  } else {
    // Magenta/Red â†’ dull yellow
    dH = 58; dS = s * 0.45; dL = l * 0.88;
  }

  const [or, og, ob] = hslToRgb(dH / 360, dS, dL);
  return [or, og, ob];
}

function hslToRgb(h, s, l) {
  if (s === 0) {
    const v = Math.round(l * 255);
    return [v, v, v];
  }
  const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
  const p = 2 * l - q;
  const hue2rgb = (t) => {
    if (t < 0) t += 1; if (t > 1) t -= 1;
    if (t < 1/6) return p + (q - p) * 6 * t;
    if (t < 1/2) return q;
    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
    return p;
  };
  return [
    Math.round(hue2rgb(h + 1/3) * 255),
    Math.round(hue2rgb(h) * 255),
    Math.round(hue2rgb(h - 1/3) * 255)
  ];
}

// â”€â”€ Render Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFrame() {
  if (video.readyState >= 2 && video.videoWidth > 0) {
    const vw = video.videoWidth, vh = video.videoHeight;
    if (viewCanvas.width !== vw || viewCanvas.height !== vh) {
      viewCanvas.width = vw;
      viewCanvas.height = vh;
    }
    ctx.drawImage(video, 0, 0, vw, vh);

    if (isDogMode) {
      const imgData = ctx.getImageData(0, 0, vw, vh);
      const d = imgData.data;
      for (let i = 0; i < d.length; i += 4) {
        const [dr, dg, db] = rgbToDog(d[i], d[i+1], d[i+2]);
        d[i] = dr; d[i+1] = dg; d[i+2] = db;
      }
      ctx.putImageData(imgData, 0, 0);
    }
  }
  animFrame = requestAnimationFrame(renderFrame);
}

// â”€â”€ Camera Start/Switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
    permMsg.style.display = 'none';
    if (animFrame) cancelAnimationFrame(animFrame);
    renderFrame();
  } catch (e) {
    alert('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ë¥¼ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  }
}

startBtn.addEventListener('click', startCamera);

flipBtn.addEventListener('click', () => {
  facingMode = facingMode === 'environment' ? 'user' : 'environment';
  startCamera();
});

toggleMode.addEventListener('click', () => {
  isDogMode = !isDogMode;
  if (isDogMode) {
    toggleMode.textContent = 'ğŸ‘¤ ì¸ê°„ ì‹œì ';
    modeLabel.textContent = 'ğŸ¶ ê°•ì•„ì§€ ì‹œì ';
  } else {
    toggleMode.textContent = 'ğŸ¶ ê°•ì•„ì§€ ì‹œì ';
    modeLabel.textContent = 'ğŸ‘¤ ì¸ê°„ ì‹œì ';
  }
});

// â”€â”€ Frame PNG (load at startup) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let frameImg = new Image();
frameImg.onload  = () => console.log('âœ“ frame.png ë¡œë“œ ì™„ë£Œ');
frameImg.onerror = () => { frameImg = null; console.log('â„¹ frame.png ì—†ìŒ â€“ í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš©'); };
frameImg.src = FRAME_PNG_PATH;

// â”€â”€ Capture + Composite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
shutterBtn.addEventListener('click', () => {
  if (!stream) return;

  // Flash
  flashOverlay.classList.add('active');
  setTimeout(() => flashOverlay.classList.remove('active'), 80);

  const vw = viewCanvas.width, vh = viewCanvas.height;
  if (!vw || !vh) return;

  const frameH = Math.round(vh * FRAME_HEIGHT_RATIO);
  captureCanvas.width  = vw;
  captureCanvas.height = vh + frameH;

  const cctx = captureCanvas.getContext('2d');
  // Draw camera frame (already dog-vision filtered)
  cctx.drawImage(viewCanvas, 0, 0, vw, vh);

  // Draw bottom frame
  if (frameImg && frameImg.complete && frameImg.naturalWidth > 0) {
    cctx.drawImage(frameImg, 0, vh, vw, frameH);
  } else {
    // Placeholder â€“ dark bar with paw icon text
    cctx.fillStyle = '#111';
    cctx.fillRect(0, vh, vw, frameH);
    // Top accent line
    cctx.fillStyle = 'rgba(212,169,106,0.7)';
    cctx.fillRect(0, vh, vw, 2);
    // Text
    const fs = Math.round(vw * 0.035);
    cctx.fillStyle = 'rgba(212,169,106,0.9)';
    cctx.font = `bold ${fs}px sans-serif`;
    cctx.textAlign = 'center';
    cctx.textBaseline = 'middle';
    cctx.fillText('ğŸ¾  DOG VISION  Â·  frame.pngë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤', vw / 2, vh + frameH / 2);
  }

  lastDataUrl = captureCanvas.toDataURL('image/jpeg', 0.93);

  // Update thumbnail
  previewThumb.innerHTML = `<img src="${lastDataUrl}" alt="preview">`;

  // Show modal
  galleryImg.src = lastDataUrl;
  galleryModal.classList.add('open');
});

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
saveBtn.addEventListener('click', () => {
  if (!lastDataUrl) return;
  const a = document.createElement('a');
  a.href = lastDataUrl;
  a.download = `dogvision_${Date.now()}.jpg`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

closeModal.addEventListener('click', () => galleryModal.classList.remove('open'));

previewThumb.addEventListener('click', () => {
  if (!lastDataUrl) return;
  galleryImg.src = lastDataUrl;
  galleryModal.classList.add('open');
});
</script>
</body>
</html>
