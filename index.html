<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dog Vision</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Noto+Sans+KR:wght@400;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --blue: #2B5BE8;
    --blue-dark: #1e44c4;
    --blue-light: #4a74ff;
    --white: #ffffff;
    --gray-cam: #b0b8c1;
  }

  html, body {
    height: 100%;
    height: 100dvh;
    overflow: hidden;
    background: var(--blue);
    font-family: 'Noto Sans KR', sans-serif;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    position: relative;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    background: var(--blue);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
    /* height will be auto based on dog height */
    padding-top: 12px;
    padding-bottom: 0;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    padding-left: 16px;
    padding-right: 16px;
  }

  .header-left {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    padding-bottom: 10px;
  }

  .app-title {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    color: var(--white);
    letter-spacing: 1px;
    line-height: 1;
  }

  .app-subtitle {
    font-size: 11px;
    color: rgba(255,255,255,0.75);
    letter-spacing: 0.5px;
  }

  /* Dog mascot peeking from header */
  .dog-mascot-wrap {
    position: relative;
    flex-shrink: 0;
    /* dog sits at bottom of header, hangs over camera area */
    margin-bottom: -40px; /* overlap amount */
    z-index: 20;
  }

  .dog-mascot {
    width: 130px;
    height: auto;
    display: block;
    filter: drop-shadow(0 4px 10px rgba(0,0,0,0.25));
  }

  /* header right controls */
  .header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    padding-bottom: 10px;
  }

  .mode-toggle {
    background: rgba(255,255,255,0.2);
    border: 1.5px solid rgba(255,255,255,0.4);
    color: white;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 12px;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .mode-toggle:active { background: rgba(255,255,255,0.35); }

  .flip-btn {
    background: rgba(255,255,255,0.2);
    border: 1.5px solid rgba(255,255,255,0.4);
    color: white;
    font-size: 16px;
    width: 34px; height: 34px;
    border-radius: 50%;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.3s;
  }
  .flip-btn:active { transform: rotate(180deg); }

  /* â”€â”€ CAMERA AREA â”€â”€ */
  .camera-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--gray-cam);
    z-index: 5;
  }

  video {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    display: none;
  }

  canvas#viewCanvas {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }

  /* Mode label badge */
  .mode-badge {
    position: absolute;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(43, 91, 232, 0.85);
    backdrop-filter: blur(6px);
    color: white;
    font-size: 12px;
    font-weight: 700;
    padding: 5px 16px;
    border-radius: 20px;
    white-space: nowrap;
    z-index: 6;
    pointer-events: none;
    border: 1px solid rgba(255,255,255,0.3);
  }

  /* Flash */
  .flash-overlay {
    position: absolute; inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 30;
    transition: opacity 0.35s ease-out;
  }
  .flash-overlay.active { opacity: 0.9; transition: none; }

  /* Permission overlay */
  .perm-overlay {
    position: absolute; inset: 0;
    background: var(--gray-cam);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    z-index: 15;
    padding: 32px;
    text-align: center;
  }
  .perm-overlay p {
    color: rgba(0,0,0,0.45);
    font-size: 14px;
    line-height: 1.7;
  }
  .start-cam-btn {
    background: var(--blue);
    color: white;
    border: none;
    padding: 13px 32px;
    border-radius: 28px;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(43,91,232,0.4);
  }

  /* â”€â”€ BOTTOM BAR â”€â”€ */
  .bottom-bar {
    background: var(--blue);
    flex-shrink: 0;
    padding: 16px 32px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
    gap: 16px;
  }

  /* Preview thumb */
  .preview-thumb {
    width: 52px; height: 52px;
    border-radius: 12px;
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    overflow: hidden;
    cursor: pointer;
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    transition: transform 0.1s;
  }
  .preview-thumb:active { transform: scale(0.93); }
  .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }

  /* Shutter */
  .shutter-wrap {
    flex-shrink: 0;
    position: relative;
    display: flex; align-items: center; justify-content: center;
  }

  .shutter-outer {
    width: 76px; height: 76px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .shutter-outer:active { transform: scale(0.9); }

  .shutter-inner {
    width: 60px; height: 60px;
    border-radius: 50%;
    background: white;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  }

  .shutter-icon {
    width: 28px; height: 28px;
    /* Camera icon via SVG */
  }

  /* Spacer to balance layout */
  .bottom-spacer {
    width: 52px; height: 52px;
    flex-shrink: 0;
  }

  /* â”€â”€ GALLERY MODAL â”€â”€ */
  .gallery-modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 100;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .gallery-modal.open { display: flex; }
  .gallery-modal img {
    max-width: 100%; max-height: 74vh;
    border-radius: 14px;
    object-fit: contain;
  }
  .modal-actions {
    display: flex; gap: 14px; margin-top: 20px;
  }
  .modal-actions button {
    padding: 11px 26px;
    border-radius: 28px;
    border: none;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
  }
  .btn-save { background: var(--blue); color: white; box-shadow: 0 4px 14px rgba(43,91,232,0.4); }
  .btn-close { background: rgba(255,255,255,0.12); color: white; }

</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="app-title">ğŸ¾ Dog Vision</div>
      <div class="app-subtitle">ê°•ì•„ì§€ì˜ ëˆˆìœ¼ë¡œ ì„¸ìƒ ë³´ê¸°</div>
    </div>

    <!-- Dog Mascot SVG (inline, so no external file needed) -->
    <div class="dog-mascot-wrap">
      <svg class="dog-mascot" viewBox="0 0 160 170" xmlns="http://www.w3.org/2000/svg">
        <!-- Body peek (paws on ledge) -->
        <!-- Left paw -->
        <ellipse cx="38" cy="148" rx="26" ry="16" fill="white" stroke="white" stroke-width="1"/>
        <ellipse cx="38" cy="148" rx="22" ry="13" fill="#d0d8f0"/>
        <!-- Right paw -->
        <ellipse cx="122" cy="148" rx="26" ry="16" fill="white" stroke="white" stroke-width="1"/>
        <ellipse cx="122" cy="148" rx="22" ry="13" fill="#d0d8f0"/>

        <!-- Neck/body -->
        <ellipse cx="80" cy="115" rx="42" ry="38" fill="white"/>
        <ellipse cx="80" cy="115" rx="36" ry="32" fill="#d0d8f0"/>

        <!-- Head base -->
        <ellipse cx="80" cy="75" rx="52" ry="50" fill="white"/>

        <!-- Ears -->
        <!-- Left ear -->
        <ellipse cx="28" cy="55" rx="20" ry="32" fill="white" transform="rotate(-15 28 55)"/>
        <ellipse cx="28" cy="55" rx="14" ry="26" fill="#d0d8f0" transform="rotate(-15 28 55)"/>
        <!-- Right ear -->
        <ellipse cx="132" cy="55" rx="20" ry="32" fill="white" transform="rotate(15 132 55)"/>
        <ellipse cx="132" cy="55" rx="14" ry="26" fill="#d0d8f0" transform="rotate(15 132 55)"/>

        <!-- Head fill over ears -->
        <ellipse cx="80" cy="70" rx="48" ry="46" fill="white"/>

        <!-- Face patch (darker fur) -->
        <ellipse cx="80" cy="68" rx="40" ry="38" fill="#c4cde8"/>
        <!-- White forehead/muzzle -->
        <ellipse cx="80" cy="52" rx="24" ry="22" fill="white"/>
        <ellipse cx="80" cy="86" rx="28" ry="22" fill="white"/>

        <!-- Eyes -->
        <circle cx="60" cy="60" r="10" fill="white"/>
        <circle cx="100" cy="60" r="10" fill="white"/>
        <circle cx="62" cy="61" r="7" fill="#1a3a9e"/>
        <circle cx="102" cy="61" r="7" fill="#1a3a9e"/>
        <circle cx="62" cy="61" r="3.5" fill="#0a1a5e"/>
        <circle cx="102" cy="61" r="3.5" fill="#0a1a5e"/>
        <!-- Eye shine -->
        <circle cx="65" cy="58" r="2" fill="white"/>
        <circle cx="105" cy="58" r="2" fill="white"/>

        <!-- Nose -->
        <ellipse cx="80" cy="80" rx="9" ry="7" fill="#1a3a9e"/>
        <ellipse cx="78" cy="78" rx="3" ry="2" fill="rgba(255,255,255,0.4)"/>

        <!-- Mouth -->
        <path d="M71 88 Q80 96 89 88" stroke="#1a3a9e" stroke-width="2.5" fill="none" stroke-linecap="round"/>

        <!-- Eyebrows -->
        <path d="M52 50 Q62 45 70 50" stroke="#9aa8d0" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        <path d="M90 50 Q98 45 108 50" stroke="#9aa8d0" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      </svg>
    </div>

    <div class="header-right">
      <button class="mode-toggle" id="toggleMode">ğŸ‘¤ ì¸ê°„ ì‹œì </button>
      <button class="flip-btn" id="flipBtn">ğŸ”„</button>
    </div>
  </div>

  <!-- CAMERA -->
  <div class="camera-area" id="cameraArea">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="viewCanvas"></canvas>
    <div class="mode-badge" id="modeBadge">ğŸ¶ ê°•ì•„ì§€ ì‹œì </div>
    <div class="flash-overlay" id="flashOverlay"></div>

    <div class="perm-overlay" id="permOverlay">
      <p>ì¹´ë©”ë¼ë¥¼ ì¼œì„œ<br>ê°•ì•„ì§€ì˜ ëˆˆìœ¼ë¡œ ì„¸ìƒì„ ë³´ì„¸ìš”</p>
      <button class="start-cam-btn" id="startBtn">ğŸ“· ì¹´ë©”ë¼ ì‹œì‘</button>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottom-bar">
    <div class="preview-thumb" id="previewThumb">ğŸ¾</div>

    <div class="shutter-wrap" id="shutterBtn">
      <div class="shutter-outer">
        <div class="shutter-inner">
          <!-- Camera SVG icon -->
          <svg viewBox="0 0 28 28" class="shutter-icon" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5 4.5L9 7H4.5C3.4 7 2.5 7.9 2.5 9V21C2.5 22.1 3.4 23 4.5 23H23.5C24.6 23 25.5 22.1 25.5 21V9C25.5 7.9 24.6 7 23.5 7H19L17.5 4.5H10.5Z" fill="#2B5BE8" stroke="#2B5BE8" stroke-width="0.5" stroke-linejoin="round"/>
            <circle cx="14" cy="15" r="4.5" fill="white"/>
            <circle cx="14" cy="15" r="2.8" fill="#2B5BE8"/>
            <circle cx="21" cy="10" r="1.2" fill="white"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="bottom-spacer"></div>
  </div>

</div>

<!-- GALLERY MODAL -->
<div class="gallery-modal" id="galleryModal">
  <img id="galleryImg" src="" alt="ì°ì€ ì‚¬ì§„">
  <div class="modal-actions">
    <button class="btn-save" id="saveBtn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
    <button class="btn-close" id="closeModal">âœ• ë‹«ê¸°</button>
  </div>
</div>

<canvas id="captureCanvas" style="display:none"></canvas>

<script>
// â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FRAME_PNG_PATH     = 'frame.png';   // ê°™ì€ í´ë”ì— frame.png ì¶”ê°€ ì‹œ ìë™ ì ìš©
const FRAME_HEIGHT_RATIO = 0.18;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let stream = null;
let facingMode = 'environment';
let isDogMode = true;
let animFrame = null;
let lastDataUrl = null;

const video          = document.getElementById('video');
const viewCanvas     = document.getElementById('viewCanvas');
const ctx            = viewCanvas.getContext('2d', { willReadFrequently: true });
const permOverlay    = document.getElementById('permOverlay');
const startBtn       = document.getElementById('startBtn');
const flipBtn        = document.getElementById('flipBtn');
const toggleMode     = document.getElementById('toggleMode');
const modeBadge      = document.getElementById('modeBadge');
const shutterBtn     = document.getElementById('shutterBtn');
const flashOverlay   = document.getElementById('flashOverlay');
const previewThumb   = document.getElementById('previewThumb');
const galleryModal   = document.getElementById('galleryModal');
const galleryImg     = document.getElementById('galleryImg');
const saveBtn        = document.getElementById('saveBtn');
const closeModal     = document.getElementById('closeModal');
const captureCanvas  = document.getElementById('captureCanvas');

// â”€â”€ Dog Vision Color Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rgbToDog(r, g, b) {
  const rn = r/255, gn = g/255, bn = b/255;
  const max = Math.max(rn,gn,bn), min = Math.min(rn,gn,bn);
  const l = (max+min)/2;
  let h=0, s=0;
  if (max!==min) {
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case rn: h=((gn-bn)/d+(gn<bn?6:0))/6; break;
      case gn: h=((bn-rn)/d+2)/6; break;
      case bn: h=((rn-gn)/d+4)/6; break;
    }
  }
  const hDeg=h*360;
  let dH, dS, dL=l;
  if (s<0.08) { return [Math.round(l*255),Math.round(l*255),Math.round(l*255)]; }
  if      (hDeg< 30) { dH=58;  dS=s*0.55; dL=l*0.88; }
  else if (hDeg< 65) { dH=55;  dS=s*0.9;  dL=l;      }
  else if (hDeg<175) { dH=0;   dS=0;      dL=l;      }
  else if (hDeg<265) { dH=218; dS=s*0.85; dL=l;      }
  else if (hDeg<330) { dH=218; dS=s*0.45; dL=l*0.92; }
  else               { dH=58;  dS=s*0.45; dL=l*0.88; }
  return hslToRgb(dH/360, dS, dL);
}

function hslToRgb(h,s,l) {
  if (s===0) { const v=Math.round(l*255); return [v,v,v]; }
  const q=l<0.5?l*(1+s):l+s-l*s, p=2*l-q;
  const f=t=>{
    if(t<0)t+=1; if(t>1)t-=1;
    if(t<1/6) return p+(q-p)*6*t;
    if(t<1/2) return q;
    if(t<2/3) return p+(q-p)*(2/3-t)*6;
    return p;
  };
  return [Math.round(f(h+1/3)*255), Math.round(f(h)*255), Math.round(f(h-1/3)*255)];
}

// â”€â”€ Render Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFrame() {
  if (video.readyState>=2 && video.videoWidth>0) {
    const vw=video.videoWidth, vh=video.videoHeight;
    if (viewCanvas.width!==vw||viewCanvas.height!==vh) {
      viewCanvas.width=vw; viewCanvas.height=vh;
    }
    ctx.drawImage(video,0,0,vw,vh);
    if (isDogMode) {
      const id=ctx.getImageData(0,0,vw,vh), d=id.data;
      for (let i=0;i<d.length;i+=4) {
        const [dr,dg,db]=rgbToDog(d[i],d[i+1],d[i+2]);
        d[i]=dr; d[i+1]=dg; d[i+2]=db;
      }
      ctx.putImageData(id,0,0);
    }
  }
  animFrame=requestAnimationFrame(renderFrame);
}

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  try {
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode, width:{ideal:1920}, height:{ideal:1080}}, audio:false
    });
    video.srcObject=stream;
    await video.play();
    permOverlay.style.display='none';
    if (animFrame) cancelAnimationFrame(animFrame);
    renderFrame();
  } catch(e) {
    alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  }
}

startBtn.addEventListener('click', startCamera);
flipBtn.addEventListener('click', () => { facingMode=facingMode==='environment'?'user':'environment'; startCamera(); });
toggleMode.addEventListener('click', () => {
  isDogMode=!isDogMode;
  toggleMode.textContent = isDogMode ? 'ğŸ‘¤ ì¸ê°„ ì‹œì ' : 'ğŸ¶ ê°•ì•„ì§€ ì‹œì ';
  modeBadge.textContent  = isDogMode ? 'ğŸ¶ ê°•ì•„ì§€ ì‹œì ' : 'ğŸ‘¤ ì¸ê°„ ì‹œì ';
});

// â”€â”€ Frame image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let frameImg=new Image();
frameImg.onload=()=>console.log('âœ“ frame.png ë¡œë“œ');
frameImg.onerror=()=>{ frameImg=null; };
frameImg.src=FRAME_PNG_PATH;

// â”€â”€ Capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
shutterBtn.addEventListener('click', () => {
  if (!stream) return;
  flashOverlay.classList.add('active');
  setTimeout(()=>flashOverlay.classList.remove('active'), 80);

  const vw=viewCanvas.width, vh=viewCanvas.height;
  if (!vw||!vh) return;
  const frameH=Math.round(vh*FRAME_HEIGHT_RATIO);
  captureCanvas.width=vw; captureCanvas.height=vh+frameH;
  const cc=captureCanvas.getContext('2d');
  cc.drawImage(viewCanvas,0,0,vw,vh);

  if (frameImg&&frameImg.complete&&frameImg.naturalWidth>0) {
    cc.drawImage(frameImg,0,vh,vw,frameH);
  } else {
    cc.fillStyle='#2B5BE8';
    cc.fillRect(0,vh,vw,frameH);
    cc.fillStyle='rgba(255,255,255,0.8)';
    cc.font=`bold ${Math.round(vw*0.033)}px sans-serif`;
    cc.textAlign='center'; cc.textBaseline='middle';
    cc.fillText('ğŸ¾ DOG VISION  Â·  frame.pngë¥¼ ì¶”ê°€í•˜ì„¸ìš”', vw/2, vh+frameH/2);
  }

  lastDataUrl=captureCanvas.toDataURL('image/jpeg',0.93);
  previewThumb.innerHTML=`<img src="${lastDataUrl}" alt="preview">`;
  galleryImg.src=lastDataUrl;
  galleryModal.classList.add('open');
});

saveBtn.addEventListener('click', () => {
  if (!lastDataUrl) return;
  const a=document.createElement('a');
  a.href=lastDataUrl; a.download=`dogvision_${Date.now()}.jpg`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

closeModal.addEventListener('click', ()=>galleryModal.classList.remove('open'));
previewThumb.addEventListener('click', ()=>{
  if (!lastDataUrl) return;
  galleryImg.src=lastDataUrl; galleryModal.classList.add('open');
});
</script>
</body>
</html>
