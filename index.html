<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dog Vision</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Noto+Sans+KR:wght@400;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  :root {
    --blue: #2B5BE8;
    --white: #ffffff;
    --gray-cam: #b0b8c1;
  }

  html, body {
    height: 100%;
    height: 100dvh;
    overflow: hidden;
    background: var(--blue);
    font-family: 'Noto Sans KR', sans-serif;
  }

  .app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    width: 100%;
  }

  /* â”€â”€ TOP IMAGE (above.png) â”€â”€ */
  .top-image-wrap {
    flex-shrink: 0;
    width: 100%;
    background: var(--blue);
    line-height: 0;
  }

  .top-image-wrap img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .top-image-wrap .img-fallback {
    width: 100%;
    padding: 20px 20px 16px;
    background: var(--blue);
    display: none;
    align-items: center;
    justify-content: center;
  }
  .top-image-wrap .img-fallback span {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 22px;
    color: white;
    letter-spacing: 1px;
  }

  /* â”€â”€ CAMERA AREA â”€â”€ */
  .camera-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: var(--gray-cam);
    min-height: 0;
  }

  video {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    display: none;
  }

  canvas#viewCanvas {
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }

  .mode-badge {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(43,91,232,0.82);
    backdrop-filter: blur(6px);
    color: white;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 14px;
    border-radius: 20px;
    white-space: nowrap;
    z-index: 6;
    pointer-events: none;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .flash-overlay {
    position: absolute; inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 30;
    transition: opacity 0.35s ease-out;
  }
  .flash-overlay.active { opacity: 0.9; transition: none; }

  .perm-overlay {
    position: absolute; inset: 0;
    background: var(--gray-cam);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    z-index: 15;
    padding: 32px;
    text-align: center;
  }
  .perm-overlay p {
    color: rgba(0,0,0,0.45);
    font-size: 14px;
    line-height: 1.7;
  }
  .start-cam-btn {
    background: var(--blue);
    color: white;
    border: none;
    padding: 13px 32px;
    border-radius: 28px;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(43,91,232,0.4);
  }

  /* â”€â”€ BOTTOM BAR â”€â”€ */
  .bottom-bar {
    background: var(--blue);
    flex-shrink: 0;
    padding: 14px 32px max(24px, env(safe-area-inset-bottom, 24px));
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
  }

  .flip-btn {
    width: 52px; height: 52px;
    border-radius: 50%;
    background: rgba(255,255,255,0.18);
    border: 2px solid rgba(255,255,255,0.35);
    color: white;
    font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: transform 0.3s, background 0.15s;
    flex-shrink: 0;
  }
  .flip-btn:active { transform: rotate(180deg); background: rgba(255,255,255,0.3); }

  .shutter-wrap {
    flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .shutter-wrap:active { transform: scale(0.88); }

  .shutter-outer {
    width: 76px; height: 76px;
    border-radius: 50%;
    background: rgba(255,255,255,0.22);
    display: flex; align-items: center; justify-content: center;
  }
  .shutter-inner {
    width: 62px; height: 62px;
    border-radius: 50%;
    background: white;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.18);
  }

  .mode-toggle {
    width: 52px; height: 52px;
    border-radius: 50%;
    background: rgba(255,255,255,0.18);
    border: 2px solid rgba(255,255,255,0.35);
    color: white;
    font-size: 22px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: background 0.15s;
    flex-shrink: 0;
  }
  .mode-toggle:active { background: rgba(255,255,255,0.3); }
  .mode-toggle .icon-label {
    font-size: 9px;
    font-weight: 700;
    margin-top: 2px;
    line-height: 1;
  }
  .mode-btn-inner {
    display: flex; flex-direction: column; align-items: center; gap: 1px;
  }

  /* â”€â”€ GALLERY MODAL â”€â”€ */
  .gallery-modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 100;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .gallery-modal.open { display: flex; }
  .gallery-modal img {
    max-width: 100%; max-height: 74vh;
    border-radius: 14px;
    object-fit: contain;
  }
  .modal-actions {
    display: flex; gap: 14px; margin-top: 20px;
  }
  .modal-actions button {
    padding: 11px 26px;
    border-radius: 28px;
    border: none;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
  }
  .btn-save { background: var(--blue); color: white; box-shadow: 0 4px 14px rgba(43,91,232,0.4); }
  .btn-close { background: rgba(255,255,255,0.12); color: white; }

  /* â”€â”€â”€â”€â”€ CAMPAIGN MODAL â”€â”€â”€â”€â”€ */
  .campaign-modal {
    position: fixed;
    inset: 0;
    background: #000;
    display: none;
    flex-direction: column;
    z-index: 9999;
    /* ëª¨ë°”ì¼ safe area ëŒ€ì‘ */
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .campaign-modal.open {
    display: flex;
  }

  /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ì˜ì—­ */
  .campaign-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* iOS ê´€ì„± ìŠ¤í¬ë¡¤ */
    overscroll-behavior: contain;
  }

  .campaign-scroll img {
    width: 100%;
    height: auto;
    display: block;
    /* ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ê¸° ì „ ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€ */
    min-height: 100px;
  }

  /* í•˜ë‹¨ ë‹«ê¸° ë²„íŠ¼ ì˜ì—­ */
  .campaign-footer {
    flex-shrink: 0;
    background: #000;
    padding: 16px 24px max(20px, env(safe-area-inset-bottom, 20px));
    display: flex;
    align-items: center;
    justify-content: center;
    border-top: 1px solid rgba(255,255,255,0.12);
  }

  .campaign-close-btn {
    background: transparent;
    color: rgba(255,255,255,0.85);
    border: 1.5px solid rgba(255,255,255,0.4);
    border-radius: 28px;
    font-family: 'Noto Sans KR', sans-serif;
    font-weight: 700;
    font-size: 15px;
    padding: 12px 48px;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: background 0.15s, color 0.15s;
    /* ëª¨ë°”ì¼ íƒ­ ì˜ì—­ ìµœì†Œ 44px ë†’ì´ ê¶Œì¥ */
    min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }
  .campaign-close-btn:active {
    background: rgba(255,255,255,0.15);
    color: #fff;
  }
</style>
</head>
<body>
<div class="app">

  <!-- TOP IMAGE -->
  <div class="top-image-wrap" id="topImageWrap">
    <img id="topImg" src="above.png" alt="top banner"
         onerror="this.style.display='none'; document.getElementById('topFallback').style.display='flex';">
    <div class="img-fallback" id="topFallback">
      <span>ğŸ¾ DOG VISION &nbsp;Â·&nbsp; above.pngë¥¼ ì¶”ê°€í•˜ì„¸ìš”</span>
    </div>
  </div>

  <!-- CAMERA -->
  <div class="camera-area" id="cameraArea">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="viewCanvas"></canvas>
    <div class="mode-badge" id="modeBadge">ğŸ¶ ê°•ì•„ì§€ ì‹œì </div>
    <div class="flash-overlay" id="flashOverlay"></div>

    <div class="perm-overlay" id="permOverlay">
      <p>ì¹´ë©”ë¼ë¥¼ ì¼œì„œ<br>ê°•ì•„ì§€ì˜ ëˆˆìœ¼ë¡œ ì„¸ìƒì„ ë³´ì„¸ìš”</p>
      <button class="start-cam-btn" id="startBtn">ğŸ“· ì¹´ë©”ë¼ ì‹œì‘</button>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <div class="bottom-bar">
    <button class="flip-btn" id="flipBtn" title="ì¹´ë©”ë¼ ì „í™˜">ğŸ”„</button>

    <div class="shutter-wrap" id="shutterBtn">
      <div class="shutter-outer">
        <div class="shutter-inner">
          <svg width="30" height="30" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10.5 4.5L9 7H4.5C3.4 7 2.5 7.9 2.5 9V21C2.5 22.1 3.4 23 4.5 23H23.5C24.6 23 25.5 22.1 25.5 21V9C25.5 7.9 24.6 7 23.5 7H19L17.5 4.5H10.5Z" fill="#2B5BE8" stroke="#2B5BE8" stroke-width="0.5" stroke-linejoin="round"/>
            <circle cx="14" cy="15" r="4.5" fill="white"/>
            <circle cx="14" cy="15" r="2.8" fill="#2B5BE8"/>
            <circle cx="21" cy="10" r="1.2" fill="white"/>
          </svg>
        </div>
      </div>
    </div>

    <button class="mode-toggle" id="toggleMode" title="ì‹œì  ì „í™˜">
      <div class="mode-btn-inner">
        <span id="modeEmoji">ğŸ¶</span>
        <span class="icon-label" id="modeLabel">ê°•ì•„ì§€</span>
      </div>
    </button>
  </div>
</div>

<!-- GALLERY MODAL -->
<div class="gallery-modal" id="galleryModal">
  <img id="galleryImg" src="" alt="ì°ì€ ì‚¬ì§„">
  <div class="modal-actions">
    <button class="btn-save" id="saveBtn">ì €ì¥í•˜ê¸°</button>
    <button class="btn-close" id="closeModal">ë‹«ê¸°</button>
  </div>
</div>

<!-- CAMPAIGN MODAL -->
<div class="campaign-modal" id="campaignModal">
  <div class="campaign-scroll">
    <img src="https://raw.githubusercontent.com/your-github-username/your-repo/main/campaign.png"
         id="campaignImage"
         alt="ìº í˜ì¸ ì´ë¯¸ì§€">
  </div>
  <div class="campaign-footer">
    <button class="campaign-close-btn" id="campaignCloseBtn">ë‹«ê¸°</button>
  </div>
</div>

<canvas id="captureCanvas" style="display:none"></canvas>

<script>
// â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FRAME_PNG_PATH     = 'frame.png';
const FRAME_HEIGHT_RATIO = 0.18;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let stream = null;
let facingMode = 'environment';
let isDogMode = true;
let animFrame = null;
let lastDataUrl = null;

const video         = document.getElementById('video');
const viewCanvas    = document.getElementById('viewCanvas');
const ctx           = viewCanvas.getContext('2d', { willReadFrequently: true });
const permOverlay   = document.getElementById('permOverlay');
const startBtn      = document.getElementById('startBtn');
const flipBtn       = document.getElementById('flipBtn');
const toggleMode    = document.getElementById('toggleMode');
const modeEmoji     = document.getElementById('modeEmoji');
const modeLabelEl   = document.getElementById('modeLabel');
const modeBadge     = document.getElementById('modeBadge');
const shutterBtn    = document.getElementById('shutterBtn');
const flashOverlay  = document.getElementById('flashOverlay');
const galleryModal  = document.getElementById('galleryModal');
const galleryImg    = document.getElementById('galleryImg');
const saveBtn       = document.getElementById('saveBtn');
const closeModal    = document.getElementById('closeModal');
const captureCanvas = document.getElementById('captureCanvas');
const campaignModal = document.getElementById('campaignModal');
const campaignCloseBtn = document.getElementById('campaignCloseBtn');

// â”€â”€ Dog Vision Color Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rgbToDog(r, g, b) {
  const rn=r/255, gn=g/255, bn=b/255;
  const max=Math.max(rn,gn,bn), min=Math.min(rn,gn,bn);
  const l=(max+min)/2;
  let h=0, s=0;
  if (max!==min) {
    const d=max-min;
    s=l>0.5?d/(2-max-min):d/(max+min);
    switch(max){
      case rn: h=((gn-bn)/d+(gn<bn?6:0))/6; break;
      case gn: h=((bn-rn)/d+2)/6; break;
      case bn: h=((rn-gn)/d+4)/6; break;
    }
  }
  const hDeg=h*360;
  let dH, dS, dL=l;
  if (s<0.08) { const v=Math.round(l*255); return [v,v,v]; }
  if      (hDeg< 30) { dH=58;  dS=s*0.55; dL=l*0.88; }
  else if (hDeg< 65) { dH=55;  dS=s*0.9;  dL=l;      }
  else if (hDeg<175) { dH=0;   dS=0;      dL=l;      }
  else if (hDeg<265) { dH=218; dS=s*0.85; dL=l;      }
  else if (hDeg<330) { dH=218; dS=s*0.45; dL=l*0.92; }
  else               { dH=58;  dS=s*0.45; dL=l*0.88; }
  return hslToRgb(dH/360, dS, dL);
}

function hslToRgb(h,s,l) {
  if (s===0) { const v=Math.round(l*255); return [v,v,v]; }
  const q=l<0.5?l*(1+s):l+s-l*s, p=2*l-q;
  const f=t=>{
    if(t<0)t+=1; if(t>1)t-=1;
    if(t<1/6) return p+(q-p)*6*t;
    if(t<1/2) return q;
    if(t<2/3) return p+(q-p)*(2/3-t)*6;
    return p;
  };
  return [Math.round(f(h+1/3)*255), Math.round(f(h)*255), Math.round(f(h-1/3)*255)];
}

// â”€â”€ Render Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFrame() {
  if (video.readyState>=2 && video.videoWidth>0) {
    const vw=video.videoWidth, vh=video.videoHeight;
    if (viewCanvas.width!==vw || viewCanvas.height!==vh) {
      viewCanvas.width=vw; viewCanvas.height=vh;
    }
    if (facingMode==='user') {
      ctx.save();
      ctx.scale(-1,1);
      ctx.drawImage(video,-vw,0,vw,vh);
      ctx.restore();
    } else {
      ctx.drawImage(video,0,0,vw,vh);
    }
    if (isDogMode) {
      const id=ctx.getImageData(0,0,vw,vh), d=id.data;
      for (let i=0;i<d.length;i+=4) {
        const [dr,dg,db]=rgbToDog(d[i],d[i+1],d[i+2]);
        d[i]=dr; d[i+1]=dg; d[i+2]=db;
      }
      ctx.putImageData(id,0,0);
    }
  }
  animFrame=requestAnimationFrame(renderFrame);
}

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  if (stream) stream.getTracks().forEach(t=>t.stop());
  try {
    stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode, width:{ideal:1920}, height:{ideal:1080}}, audio:false
    });
    video.srcObject=stream;
    await video.play();
    permOverlay.style.display='none';
    if (animFrame) cancelAnimationFrame(animFrame);
    renderFrame();
  } catch(e) {
    alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
  }
}

startBtn.addEventListener('click', startCamera);

flipBtn.addEventListener('click', () => {
  facingMode = facingMode==='environment' ? 'user' : 'environment';
  startCamera();
});

toggleMode.addEventListener('click', () => {
  isDogMode = !isDogMode;
  if (isDogMode) {
    modeEmoji.textContent = 'ğŸ¶';
    modeLabelEl.textContent = 'ê°•ì•„ì§€';
    modeBadge.textContent = 'ğŸ¶ ê°•ì•„ì§€ ì‹œì ';
  } else {
    modeEmoji.textContent = 'ğŸ‘¤';
    modeLabelEl.textContent = 'ì¸ê°„';
    modeBadge.textContent = 'ğŸ‘¤ ì¸ê°„ ì‹œì ';
  }
});

// â”€â”€ Frame image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let frameImg = new Image();
frameImg.onload  = () => console.log('frame.png ë¡œë“œ ì™„ë£Œ');
frameImg.onerror = () => { frameImg = null; };
frameImg.src = FRAME_PNG_PATH;

// â”€â”€ Capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
shutterBtn.addEventListener('click', () => {
  if (!stream) return;

  flashOverlay.classList.add('active');
  setTimeout(() => flashOverlay.classList.remove('active'), 80);

  const vw=viewCanvas.width, vh=viewCanvas.height;
  if (!vw||!vh) return;

  const side = Math.min(vw, vh);
  const sx = Math.floor((vw - side)/2);
  const sy = Math.floor((vh - side)/2);
  const frameH = Math.round(side * FRAME_HEIGHT_RATIO);
  captureCanvas.width  = side;
  captureCanvas.height = side + frameH;

  const cc = captureCanvas.getContext('2d');
  cc.drawImage(viewCanvas, sx, sy, side, side, 0, 0, side, side);

  if (frameImg && frameImg.complete && frameImg.naturalWidth>0) {
    cc.drawImage(frameImg, 0, side, side, frameH);
  } else {
    cc.fillStyle = '#2B5BE8';
    cc.fillRect(0, side, side, frameH);
    cc.fillStyle = 'rgba(255,255,255,0.8)';
    cc.font = `bold ${Math.round(side*0.033)}px sans-serif`;
    cc.textAlign = 'center'; cc.textBaseline = 'middle';
    cc.fillText('DOG VISION', side/2, side+frameH/2);
  }

  lastDataUrl = captureCanvas.toDataURL('image/jpeg', 0.93);
  galleryImg.src = lastDataUrl;
  galleryModal.classList.add('open');
});

// â”€â”€ ì €ì¥ í›„ ìº í˜ì¸ ëª¨ë‹¬ í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
saveBtn.addEventListener('click', () => {
  if (!lastDataUrl) return;

  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  const a = document.createElement('a');
  a.href = lastDataUrl;
  a.download = `dogvision_${Date.now()}.jpg`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  // ê°¤ëŸ¬ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
  galleryModal.classList.remove('open');

  // ìº í˜ì¸ ëª¨ë‹¬ ì—´ê¸° & ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
  const scrollEl = campaignModal.querySelector('.campaign-scroll');
  if (scrollEl) scrollEl.scrollTop = 0;
  campaignModal.classList.add('open');
});

closeModal.addEventListener('click', () => galleryModal.classList.remove('open'));

// â”€â”€ ìº í˜ì¸ ë‹«ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
campaignCloseBtn.addEventListener('click', () => {
  campaignModal.classList.remove('open');
});
</script>
</body>
</html>
